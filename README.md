# Gym-Server ‚Äî Fitness AI Backend

A FastAPI backend that provides fitness and diet services powered by helper AI modules and stores user data in a SQL database. It supports profile management, AI-driven diet & workout suggestions, calorie detection from images, chat assistant, gym suggestions, and PDF export of weekly workout plans.

---

## üöÄ Features
- Create and manage user profiles
- Generate daily diet plans (AI-backed)
- Generate weekly workout plans (AI-backed)
- Download workout plans as PDF
- Detect calories and food analysis from images (file upload)
- Chat assistant per-user
- Custom ingredient-driven diets
- Gym recommendations
- Simple persistence using SQLAlchemy models (Postgres / PostgreSQL recommended)

## üìÅ Project layout (important files)
- `app/main.py` ‚Äî FastAPI app & router registration
- `app/config.py` ‚Äî loads environment variables
- `app/database.py` ‚Äî SQLAlchemy setup
- `app/models.py` ‚Äî ORM models for profiles, diets, workouts, logs
- `app/routers/` ‚Äî API routers (profile, workout, calorie, chat, gym, custom diet, diet history)
- `app/ai/` ‚Äî helper AI modules (diet_suggestion, workout_suggestion, calorie_detector, chatbot, gym_suggestion, custom_diet)
- `app/utils/pdf.py` ‚Äî PDF generator: `workout_plan_to_pdf_bytes()`
- `tests/` ‚Äî small unit tests (PDF generator tests included)

## üß≠ Quick start (local)
1. Install Python 3.10+ and create a virtual environment

  ```bash
  python -m venv .venv
  source .venv/bin/activate
  pip install --upgrade pip
  ```

2. Install runtime dependencies (FastAPI, Uvicorn, SQLAlchemy, etc.)

  ```bash
  pip install fastapi uvicorn sqlalchemy psycopg2-binary python-dotenv reportlab
  ```

  Note: `requirements.txt` currently lists only `reportlab`. You may want to freeze the full project dependencies into that file after creating an environment.

3. Create an `.env` file in the project root and provide at least the `DB_URL`. Example `.env`:

  ```env
  DB_URL=postgresql+psycopg2://username:password@localhost:5432/gym_db
  APP_NAME=Gym-Server
  BASE_URL=http://localhost:8000
  GROQ_API_KEY=your_groq_key_here   # optional
  GOOGLE_API_KEY=your_google_api_key # optional
  ```

4. Start the app

  ```bash
  uvicorn app.main:app --reload --host 0.0.0.0 --port 8000
  ```

5. Open docs at: http://localhost:8000/docs (auto-generated by FastAPI)

---

## üîå Database & Models
- The app uses SQLAlchemy and will create tables at startup using the engine configured in `app/database.py`.
- Recommended: run a Postgres/PostGIS instance and point `DB_URL` to it. Models include `UserProfile`, `UserDiet`, `UserWorkout`, `UserFoodLog`, `ChatHistory`, `GymSuggestion`, and `UserCustomDiet`.

## üîç Main API endpoints (overview)
All API routes are namespaced under `/profile` (unless otherwise noted). Main endpoints include:

- POST /profile ‚Äî Create user profile (body: Profile data)
- PATCH /profile/update ‚Äî Update profile (body: updated fields)
- POST /profile/diet-plan ‚Äî Generate / return today‚Äôs AI diet plan for a user
- POST /profile/diet-history ‚Äî Get user's previous diets (excluding today)
- POST /profile/workout-plan ‚Äî Generate / return weekly workout plan
- POST /profile/workout-plan/pdf-download ‚Äî Return a PDF file for a user's workout plan
- POST /profile/calorie/detect ‚Äî Upload image file (multipart) ‚Üí run calorie detection -> save log
- POST /profile/calorie/history ‚Äî Get saved calorie detection history
- DELETE /profile/calorie/delete ‚Äî Delete a calorie log entry by ID
- POST /profile/chat ‚Äî Chat endpoint (user-specific chat assistant)
- POST /profile/custom-diet ‚Äî Create or return a custom ingredient-driven diet plan
- POST /profile/gym-suggestion ‚Äî Get a gym suggestion for a user

Exercise-related endpoints (new)
- POST /profile/exercise/validate ‚Äî Multipart: (email + image file). Uses the multimodal AI detector to validate whether an image contains an exercise and returns a JSON result (is_exercise, confidence, label, explanation). This endpoint is validation-only and does not persist images or results by default.
- POST /profile/exercise/follow-up ‚Äî JSON body: store daily follow-up data for a user. Required: `email`, `date` (YYYY-MM-DD). Optional: `day`, `completed_exercises`, `completion_rate`, `total_exercises`, `exercises` (JSON array). This data is persisted for later analysis.
- POST /profile/analysis ‚Äî JSON body: `{"email":"...","week_start":"YYYY-MM-DD","week_end":"YYYY-MM-DD"}` ‚Üí Aggregates follow-ups for the requested week and returns a structured week summary plus an AI-generated `advice` string. Behavior:
  - The endpoint returns a full-week `daily_stats` array (one entry per day from week_start to week_end). For days after "today" the API returns `total_exercises: 0` and `completed_exercises: 0` (future days are shown as zeros, not omitted). 
  - The first request for a particular (email, week_start, week_end) will generate analysis using the AI and the result is cached in the `user_exercise_analyses` table. Subsequent identical requests return the stored analysis (consistency + cheaper operations).

### Example: download workout PDF

```bash
curl -X POST "http://localhost:8000/profile/workout-plan/pdf-download" \
  -H "Content-Type: application/json" \
  -d '{"email":"user@example.com","week_start":"2025-11-24"}' --output workout.pdf
```

---

## üß† AI components
The heavy-lifting for the AI features lives inside `app/ai/`:
- `diet_suggestion.py` ‚Äî DietAssistant that returns a daily diet plan
- `workout_suggestion.py` ‚Äî WorkoutAssistant that builds a weekly workout program
- `calorie_detector.py` ‚Äî Image analysis and calorie estimator (saves logs)
 - `exercise_detector.py` ‚Äî Vision-capable AI model that verifies whether an uploaded image is an exercise (used by the `/profile/exercise/validate` endpoint)
 - `exercise_analysis.py` ‚Äî Aggregates weekly follow-ups and calls the AI to generate a short, tailored weekly advice string and structured weekly output (week_start/week_end/daily_stats/advice). Results are cached to `user_exercise_analyses`.
- `chatbot.py` ‚Äî Per-user chat assistant that keeps chat history
- `gym_suggestion.py`, `custom_diet.py` ‚Äî helpers for gym and custom diet generation

These helpers can call external APIs or run local models depending on configuration/environment variables (e.g. GROQ_API_KEY, GOOGLE_API_KEY, etc.).

---

## ‚úÖ Tests
- Run tests with pytest:

```bash
pytest -q
```

There are unit tests for the PDF generator under `tests/test_workout_pdf.py`.

Added tests:
- `tests/test_exercise_detector.py` ‚Äî encoder/prompt checks for the exercise detector.
- `tests/test_exercise_router.py` ‚Äî endpoint tests for the multipart validation endpoint (mocked AI).
- `tests/test_exercise_followup.py` ‚Äî tests for storing follow-up payloads (DB override in tests).
- `tests/test_analysis.py` ‚Äî aggregation, AI-invocation, caching and future-day behavior for `/profile/analysis`.

---

## üõ†Ô∏è Developer notes
- PDF bytes generator: `app/utils/pdf.py` ‚Üí `workout_plan_to_pdf_bytes(user_name, week_start, week_end, week_number, workout_plan)`.
- The app mounts a static folder at `/static` and stores uploaded images to `app/static/images`.
- Database tables are created automatically on app start (via `Base.metadata.create_all(bind=engine)` in `app/main.py`) ‚Äî for production use migrate with a proper migration system (Alembic).
  - Note: if you run the app locally and rely on `Base.metadata.create_all(bind=engine)`, the new tables (e.g. `user_exercise_followups`, `user_exercise_analyses`) will be created automatically. For production or CI environments use Alembic to add explicit migrations.

## ü§ù Contributing
Feel free to open issues or pull requests. If you add new third-party integrations or model usage, update `requirements.txt` or provide a separate requirements file for reproducibility.

## üìú License
This project does not include a license file in the repository. Add one if you want to open-source the project (e.g., MIT, Apache-2.0).

---

If you want, I can also:

- add more example curl / Python client samples for each endpoint
- expand `requirements.txt` with all required packages and pinned versions
- add a small `docker-compose.yml` to bring up a local Postgres + the API server for easier testing

Let me know which of these you'd like next.
